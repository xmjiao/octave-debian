#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1

# This has to be exported to make some magic below work.
export DH_OPTIONS

# Needed by octave-common.links
include /usr/share/dpkg/pkg-info.mk
DEB_VERSION_UPSTREAM := $(subst ~rc,-rc,$(DEB_VERSION_UPSTREAM))
export DEB_VERSION_UPSTREAM

# Configure default Java paths using javahelper except on some archs.
# On hurd-i386 octave FTBFS against gcj-4.8, which is default-jdk.
# On mipsel java unit tests calling openjdk-7 cause a bus error at runtime.
# This arch list must be kept in sync with the arch list qualifying
# default-{jdk,jre} in debian/control.
NO_JDK_ARCHS := hurd-i386 mipsel
ifneq (,$(findstring $(DEB_HOST_ARCH),$(NO_JDK_ARCHS)))
WITH_JAVA_FLAGS := --disable-java
else
include /usr/share/javahelper/java-vars.mk
JAVA_LIBDIR := $(firstword $(JVM_CLIENT_DIR) $(JVM_SERVER_DIR))
WITH_JAVA_FLAGS := --with-java-homedir=$(JAVA_HOME) --with-java-libdir=$(JAVA_LIBDIR)
endif

# Disable the JIT on some archs. JIT unit tests with LLVM currently segfault
# on all non-x86 archs. This arch list must be kept in sync with the arch
# list qualifying llvm-dev in debian/control.
include /usr/share/dpkg/architecture.mk
NO_JIT_ARCHS := armel armhf mips mipsel powerpc
ifneq (,$(findstring $(DEB_HOST_ARCH),$(NO_JIT_ARCHS)))
DISABLE_JIT_FLAG := --disable-jit
endif

%:
	dh $@ --with autoreconf --parallel

clean:
	dh clean --with autoreconf

# override normal dh_auto_configure call to pass OpenMP flag to it (#631831)
override_dh_auto_configure:
	dh_auto_configure -- --enable-openmp $(WITH_JAVA_FLAGS) $(DISABLE_JIT_FLAG)

# dh_auto_test tries to run "make test", so override it
override_dh_auto_test:
	xvfb-run make check

# override normal dh_compress call to avoid compressing .pdf files
override_dh_compress:
	dh_compress -O--parallel --exclude=.pdf

# override this call, so we do not pass the --parallel option to it; 
# "make -j2 install" does not work as of now
override_dh_auto_install:
	# Smuggle our configuration file into the installed files
	mkdir -p debian/tmp/etc && cp debian/octave.conf debian/tmp/etc/
	dh_auto_install --max-parallel=1
	# Delete .la files (for liboctgui)
	find debian/tmp -name '*.la' -delete

# The info files have references to .png images
# Rename them by prefixing their name with "octave-", adapt the *.info files to
#  this new name, and ship the images under /usr/share/info
override_dh_installinfo-indep:
	dh_installinfo
	for f in `grep -a src=\".*\" doc/interpreter/*.info* | sed 's/.*src="\([^"]*\)".*/\1/'`; do \
		cp doc/interpreter/$$f debian/octave-info/usr/share/info/octave-$$f; \
		sed -i "s/src=\"$$f\"/src=\"octave-$$f\"/g" debian/octave-info/usr/share/info/octave.info*; \
	done

# save debug information into the debug package
override_dh_strip:
	dh_strip -a --dbg-package=octave-dbg

# Strip the executable bit from the .oct files
# Cannot be done in dh_fixperms, as then dh_strip and dh_shlibdeps don't take the
# .oct files into account
override_dh_shlibdeps:
	dh_shlibdeps -O--parallel
	find debian/octave -name '*.oct' -print0 2>/dev/null | xargs -0r chmod 644

get-orig-source:
	uscan --force-download --rename --destdir .
.PHONY: get-orig-source
